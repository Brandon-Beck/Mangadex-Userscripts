javascript:"use strict";const isUserscript=void 0!==window.GM_xmlhttpRequest;if(!isUserscript&&!window.location.href.startsWith("https://mangadex.org"))throw alert("Mangadex Post Preview script only works on https://mangadex.org"),Error("Mangadex Post Preview script only works on https://mangadex.org");function loadScript(e){const{head:t}=document,n=document.createElement("script");return n.type="text/javascript",n.src=e,new Promise((e,o)=>{n.onload=e,n.onerror=o,t.appendChild(n)})}const imageBlobs={};function getImageBlob(e){return imageBlobs[e]||(imageBlobs[e]=new Promise((t,n)=>{GM_xmlhttpRequest({method:"GET",url:e,responseType:"blob",onerror:n,ontimeout:n,onload:o=>(o.status>=200&&o.status<=299||304===o.status)&&o.response?(imageBlobs[e]=Promise.resolve(o.response),t(imageBlobs[e])):n(o)})})),imageBlobs[e]}function getImageObjectURL(e){return getImageBlob(e).then(e=>URL.createObjectURL(e))}const imgCache={};function cloneImageCacheEntry(e){const t=e.element.cloneNode(),{loadPromise:n}=e;return{element:t,loadPromise:n}}function getImgForURL(e){return isUserscript?getImgForURLViaFetch(e):getImgForURLViaImg(e)}function getImgForURLViaImg(e){if(void 0!==imgCache[e])return cloneImageCacheEntry(imgCache[e]);const t=document.createElement("img"),n=new Promise((n,o)=>{t.onload=()=>n(t),t.onerror=e=>o(new Error(e.toString())),t.src=e});return imgCache[e]={element:t,loadPromise:n},imgCache[e]}function getImgForURLNoCache(e){const t=document.createElement("img"),n=new Promise((n,o)=>{t.onload=()=>n(t),t.onerror=e=>o(new Error(e.toString())),t.src=e});return{element:t,loadPromise:n}}function getImgForURLViaFetch(e){const t=getImageObjectURL(e),n=document.createElement("img"),o=t.then(e=>new Promise((t,o)=>{n.onload=()=>{URL.revokeObjectURL(e),t(n)},n.onerror=t=>{URL.revokeObjectURL(e),o(new Error(t.toString()))},n.src=e}));return{element:n,loadPromise:o}}function getImgForURLViaFetchClone(e){if(void 0!==imgCache[e])return cloneImageCacheEntry(imgCache[e]);const t=getImageObjectURL(e),n=document.createElement("img"),o=t.then(e=>new Promise((t,o)=>{n.onload=()=>{t(n)},n.onerror=e=>{o(new Error(e.toString()))},n.src=e}));return imgCache[e]={element:n,loadPromise:o},imgCache[e]}let generatedBBCodePegParser;function tokensToSimpleAST(e){if(null==e)return[];const t=[{type:"root",content:[],location:[0,0]}],n=[t[0]];let o=t[0];e.forEach(e=>{if("open"===e.type){const t={type:e.type,tag:e.tag,content:[],location:e.location};o.content.push(t),o.location[1]=e.location[1],o=t,n.push(t)}else if("prefix"===e.type){const t={type:e.type,tag:e.tag,content:[],location:e.location};"prefix"===o.type&&(o.location[1]=e.location[0],n.pop(),o=n[n.length-1]),o.content.push(t),o.location[1]=e.location[1],o=t,n.push(t)}else if("opendata"===e.type){const t={type:e.type,tag:e.tag,content:[],location:e.location};t.data=e.attr,o.content.push(t),o.location[1]=e.location[1],o=t,n.push(t)}else if("close"===e.type){let t=Object.values(n).reverse().findIndex(t=>t.tag===e.tag);if(-1!==t){t+=1;for(let o=n.length-t;o<n.length;o++)n[o].location[1]=e.location[1];n.splice(-t,t),o.location[1]=e.location[1],o=n[n.length-1]}else{const t={type:"error",content:`[/${e.tag}]`,location:e.location};o.location[1]=e.location[1],o.content.push(t)}}else"linebreak"===e.type?"prefix"===o.type?(o.location[1]=e.location[0],o.content.push(e),n.pop(),o=n[n.length-1]):(({location:[,o.location[1]]}=e),o.content.push(e)):(o.location[1]=e.location[1],o.content.push(e))});for(let e=1;e<n.length;e++)n[e].location[1]=o.location[1];return t[0].content}function bbcodeTokenizer(){return generatedBBCodePegParser||(generatedBBCodePegParser=peg.generate(String.raw`${"\n"}start = tokens:Expressions? {return tokens}${"\n"}Expressions = tokens:Expression+ {${"\n"}  return tokens${"\n"}}${"\n"}Expression = res:(OpenTag / OpenDataTag / CloseTag / PrefixTag / LineBreak / Text )${"\n"}/*head:Term tail:(_ ("+" / "-") _ Term)* {${"\n"}      return tail.reduce(function(result, element) {${"\n"}        if (element[1] === "+") { return result + element[3]; }${"\n"}        if (element[1] === "-") { return result - element[3]; }${"\n"}      }, head);${"\n"}    }${"\n"}*/${"\n"}Tag = tag:(OpenCloseTag / PrefixTag) {return tag}${"\n"}OpenCloseTag = open:(OpenTag / OpenDataTag) content:Expression? close:CloseTag?${"\n"}  &{${"\n"}    let hasClose = close != null${"\n"}    if (false && hasClose && open.tag != close.tag) {${"\n"}      throw new Error(${"\n"}          "Expected [/" + open.tag + "] but [/" + close.tag + "] found."${"\n"}      );${"\n"}    }${"\n"}    return true${"\n"}} {${"\n"}    return {type:open.tag, data:open.attr, content}${"\n"}}${"\n"}PrefixTag = "[" tag:PrefixTagList "]" { return {type:"prefix", tag:tag, location:[location().start.offset,location().end.offset]} }${"\n"}${"\n"}// PrefixTag = "[" tag:PrefixTagList "]" content:(!("[/" ListTags "]" / LineBreak ) .)* { return {type:tag,unparsed:content.join('')} }${"\n"}${"\n"}ListTags = "list" / "ul" / "ol" / "li"${"\n"}${"\n"}NormalTagList = "list" / "spoiler" / "center" / "code" / "quote" / "img" /  "sub" / "sup" / "left" / "right" / "ol" / "ul" / "h1" / "h2" / "h3" / "h4" / "hr" / "h" / "b" / "s" / "i" / "u"${"\n"}DataTagList = "url"${"\n"}PrefixTagList = "*"${"\n"}${"\n"}Data${"\n"}  = text:(!"]". Data?) {${"\n"}  /*if(text[2] != null) {${"\n"}    return {type: "data", content:text[1] + text[2].content }${"\n"}  }${"\n"}  return {type: "data", content:text[1] }${"\n"}  */${"\n"}  if(text[2] != null) {${"\n"}    return text[1] + text[2]${"\n"}  }${"\n"}  return text[1]${"\n"}}${"\n"}OpenTag = "[" tag:NormalTagList "]" { return {type:"open", tag:tag, location:[location().start.offset,location().end.offset] } }${"\n"}AttrTagProxy = "=" attr:Data? {return attr}${"\n"}OpenDataTag = "[" tag:DataTagList attr:AttrTagProxy?  "]" { return {type:"opendata", tag:tag,attr:attr, location:[location().start.offset,location().end.offset]} }${"\n"}${"\n"}CloseTag = "[/" tag:(DataTagList / NormalTagList / PrefixTagList ) "]" { return {type:"close", tag:tag, location:[location().start.offset,location().end.offset]} }${"\n"}${"\n"}${"\n"}Text${"\n"}  = text:(!(Tag / CloseTag / LineBreak). Text?) {${"\n"}  if(text[2] != null) {${"\n"}    return {type: "text", content:text[1] + text[2].content, location:[location().start.offset,text[2].location[1]] }${"\n"}  }${"\n"}  return {type: "text", content:text[1], location:[location().start.offset,location().end.offset] }${"\n"}}${"\n"}ContiguousText${"\n"}  = text:(!(Tag / CloseTag / LineBreak / _ ). ContiguousText?) {${"\n"}  if(text[2] != null) {${"\n"}    return {type: "text", content:text[1] + text[2].content, location:[location().start.offset,text[2].location[1]] }${"\n"}  }${"\n"}  return {type: "text", content:text[1], location:[location().start.offset,location().end.offset] }${"\n"}}${"\n"}LineBreak${"\n"}  = [\n] {${"\n"}  return {type: "linebreak", location:[location().start.offset,location().end.offset] }${"\n"}}${"\n"}ErrorCatcher${"\n"}  = errTxt:. {return {type: "error", content: errTxt, location:[location().start.offset,location().end.offset]} }${"\n"}${"\n"}_ "whitespace"${"\n"}  = [ \t\n\r]*${"\n"}`))}function astToHtmlAst(e){if(null==e)return[];if("object"!=typeof e)return[];function t(e,t,n){e.push({type:"text",element:n,location:t.location})}return e.reduce((n,o)=>{if("text"===o.type)t(n,o,document.createTextNode(o.content));else if("linebreak"===o.type){const e={element:document.createElement("br"),location:o.location,type:"container",contains:[]};n.push(e)}else if("error"===o.type)t(n,o,document.createTextNode(o.content));else{if("open"!==o.type&&"prefix"!==o.type&&"opendata"!==o.type)throw new Error({msg:`Unknown AST type "${o.type}" recieved!`,child_ast:o,container_ast:e});if("u"===o.tag||"s"===o.tag||"sub"===o.tag||"sup"===o.tag||"ol"===o.tag||"code"===o.tag||"h1"===o.tag||"h2"===o.tag||"h3"===o.tag||"h4"===o.tag||"h5"===o.tag||"h6"===o.tag){const e={element:document.createElement(o.tag),location:o.location,type:"container",contains:[]};n.push(e),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("list"===o.tag||"ul"===o.tag){const e={element:document.createElement("ul"),location:o.location,type:"container",contains:[]};n.push(e),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("hr"===o.tag){const e={element:document.createElement(o.tag),location:o.location,type:"container",contains:[]};n.push(e),astToHtmlAst(o.content).forEach(e=>{n.push(e)})}else if("b"===o.tag){const e={element:document.createElement("strong"),location:o.location,type:"container",contains:[]};n.push(e),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("i"===o.tag){const e={element:document.createElement("em"),location:o.location,type:"container",contains:[]};n.push(e),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("h"===o.tag){const e={element:document.createElement("mark"),location:o.location,type:"container",contains:[]};n.push(e),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("url"===o.tag){const e={element:document.createElement("a"),location:o.location,type:"container",contains:[]};n.push(e),e.element.target="_blank",o.data&&(e.element.href=o.data),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("img"===o.tag){let e="";if(o.content){const t=o.content[0];t&&"text"===t.type&&(e=t.content)}const t=getImgForURL(e),a={element:t.element,location:o.location,type:"image",imagePromise:t.loadPromise.then(()=>e)};a.element.style.maxWidth="100%",a.element.classList.add("align-bottom"),n.push(a)}else if("quote"===o.tag){const e={element:document.createElement("div"),location:o.location,type:"container",contains:[]};n.push(e),e.element.style.width="100%",e.element.style.display="inline-block",e.element.style.margin="1em 0",e.element.classList.add("well","well-sm"),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("spoiler"===o.tag){const e={element:document.createElement("button"),location:o.location,type:"container",contains:[]};e.element.textContent="Spoiler",e.element.classList.add("btn","btn-sm","btn-warning","btn-spoiler"),n.push(e);const t={element:document.createElement("div"),location:o.location,type:"container",contains:[]};n.push(t),t.element.classList.add("spoiler","display-none"),t.contains=astToHtmlAst(o.content),t.contains.forEach(e=>{t.element.appendChild(e.element)})}else if("center"===o.tag||"left"===o.tag||"right"===o.tag){const e={element:document.createElement("div"),location:o.location,type:"container",contains:[]};n.push(e),e.element.classList.add(`text-${o.tag}`),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else if("*"===o.tag){const e={element:document.createElement("li"),location:o.location,type:"container",contains:[]};n.push(e),e.contains=astToHtmlAst(o.content),e.contains.forEach(t=>{e.element.appendChild(t.element)})}else{if(null==o.content)throw Error(`Recieved unknown and unhandeled ast entry '${JSON.stringify(o)}'`);astToHtmlAst(o.content).forEach(e=>{n.push(e)})}}return n},[])}function makePreview(e){const t=astToHtmlAst(tokensToSimpleAST(bbcodeTokenizer().parse(e))),n=document.createElement("div");return n.style.flexGrow="1",t.forEach(e=>n.appendChild(e.element)),n.classList.add("postbody","mb-3","mt-4"),n.style.wordWrap="break-word",n.style.wordBreak="break-word",[n,t]}function createPreviewCallbacks(){const e=document.querySelector("nav.navbar.fixed-top");let t;const n=t=void 0===e?0:void 0!==e.getBoxQuads?e.getBoxQuads()[0].p3.y:e.getBoundingClientRect().height;let o=Object.values(document.querySelectorAll(".post_edit_form"));(o=(o=o.concat(Object.values(document.querySelectorAll("#post_reply_form")))).concat(Object.values(document.querySelectorAll("#change_profile_form, #start_thread_form")))).forEach(e=>{const t=e.querySelector("textarea");if(!t)return Error("Failed to find text area for forum");let o,a=0,l=1,r=50;const i=1e4,s=!1;if(!e.parentElement)return;e.parentElement.style.alignItems="flex-start",e.parentElement.classList.add("d-flex"),e.parentElement.style.flexDirection="row-reverse",e.style.position="sticky",e.style.top="0px",e.style.width="min-content",e.style.paddingTop=`${n}px`,e.style.marginTop=`-${n}px`,t.style.resize="both",t.style.minWidth="120px",t.style.width="25vw",t.style.paddingLeft="0",t.style.paddingRight="0";let[c,m]=makePreview(t.value);e.parentElement.insertBefore(c,e);const p=e.parentElement.parentElement.firstElementChild;let g;function d(o=t.selectionStart){g&&(g.style.display="none",g=void 0);const a=function e(t,n){const o=t.slice().reverse().find(e=>e.location[0]<=n&&n<=e.location[1]);if(o){if("container"===o.type){!g&&3!==o.element.nodeType&&o.element.classList.contains("spoiler")&&"block"!==o.element.style.display&&((g=o.element).style.display="block");const t=e(o.contains,n);if(t)return t}return o.element}}(m,o);if(a){if(3===a.nodeType){let e;e=void 0!==a.getBoxQuads?a.getBoxQuads()[0].p1.y:a.parentElement.getBoundingClientRect().top,document.scrollingElement.scrollBy(0,e)}else a.scrollIntoView();document.scrollingElement.scrollBy(0,-n);const t=e.getBoundingClientRect();document.scrollingElement.scrollBy(0,t.top)}}function u(){const e=Date.now(),n=l++,[o,p]=makePreview(t.value);$(o).find(".btn-spoiler").click(()=>{$(this).next(".spoiler").toggle()});const g=[];Object.values(o.querySelectorAll("img")).forEach(e=>{g.push(new Promise(t=>{e.addEventListener("load",t),e.addEventListener("error",t),e.complete&&t()}))}),Promise.all(g).then(()=>{const t=Date.now()-e;!s&&t>i||(r=(r+t)/2),n<a?o.remove():(a=n,c.parentElement.insertBefore(o,c),c.remove(),c=o,m=p,d())})}function f(){clearTimeout(o),o=setTimeout(u,r)}p!==e.parentElement&&("img"===p.firstChild.nodeName.toLowerCase()?(p.firstChild.remove(),p.appendChild(e),e.parentElement.classList.remove("p-3"),e.parentElement.classList.add("pb-3"),e.parentElement.parentElement.classList.add("post")):(e.classList.add("pr-3"),"change_profile_form"===e.id&&(t.parentElement.style.flexBasis="100%",t.parentElement.style.maxWidth="100%"))),t.addEventListener("selectionchange",()=>{a===l-1&&null!=m[m.length-1]&&m[m.length-1].location[1]===t.value.length&&d()}),Object.values(e.querySelectorAll("button")).forEach(e=>{e.addEventListener("click",f)}),t.oninput=f})}isUserscript?createPreviewCallbacks():loadScript("https://gitcdn.xyz/cdn/pegjs/pegjs/30f32600084d8da6a50b801edad49619e53e2a05/website/vendor/pegjs/peg.js").then(()=>{createPreviewCallbacks()});
